{% extends 'base.html' %}

{% block title %}üìä Reading Stats{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='stats.css') }}">
{% endblock %}

{% block content %}
  <h1>üìä My Reading Stats</h1>

  <div class="stats-section">
    <div class="card-grid">
      <div class="card"><strong>Total Books Read</strong>{{ total_books }}</div>
      <div class="card"><strong>Average Rating</strong>{{ avg_rating }}</div>
      <div class="card"><strong>Top Mood</strong>{{ most_common_mood }} {{ mood_config[most_common_mood]['emoji'] }}</div>
    </div>
  </div>

  <div class="stats-section">
    <h2>üìö Top 3 Books</h2>
    <div class="card-grid">
      {% for book in top_books %}
        <div class="card top-book-card">
          {% if book.thumbnail %}
            <img src="{{ book.thumbnail }}" alt="Cover of {{ book.title }}" class="top-book-cover">
          {% else %}
            <div class="top-book-placeholder">üìò</div>
          {% endif %}
          <strong>{{ book.title }}</strong>
          <em>{{ book.author }}</em><br>
          ‚≠ê {{ book.rating }}/5
        </div>
      {% endfor %}
    </div>
  </div>
  

  <div class="stats-section">
    <h2>üé® Mood Distribution</h2>
    <div class="card-grid">
      {% for mood, count in mood_counts.items() %}
      <div class="card mood-card" 
      onclick="toggleBooks('{{ mood|replace(' ', '_') }}')" 
        style="border-left: 6px solid {{ mood_config[mood]['color'] }}">
 
          <strong>{{ mood }} {{ mood_config[mood]['emoji'] }}</strong>
          {{ count }} book{{ 's' if count != 1 }}
          <div id="books-{{ mood|replace(' ', '_') }}" class="book-list">
            {% for book in mood_books[mood] %}
              <div class="book-entry">üìñ {{ book.title }} ‚Äî ‚≠ê {{ book.rating }}/5</div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="stats-section">
    <h2>üìà Visual Charts</h2>
    <div class="charts-container">
      <div class="chart-box">
        <h3>Mood Distribution</h3>
        <canvas id="moodChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Average Rating by Mood</h3>
        <canvas id="ratingByMoodChart"></canvas>
      </div>
      <div class="chart-box">
        <h3>Books per Rating</h3>
        <canvas id="booksPerRatingChart"></canvas>
      </div>
    </div>
  </div>

  <a href="{{ url_for('index') }}" class="back-link">‚Üê Back to Shelf</a>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const moodColorMap = {{ mood_colors | tojson }};
    const moodLabels = {{ mood_counts.keys() | list | tojson }};
    const moodValues = {{ mood_counts.values() | list | tojson }};
    const ratingMoods = {{ avg_rating_by_mood.keys() | list | tojson }};
    const ratingValues = {{ avg_rating_by_mood.values() | list | tojson }};
    const booksPerRatingLabels = {{ books_per_rating.keys() | list | tojson }};
    const booksPerRatingValues = {{ books_per_rating.values() | list | tojson }};
  </script>
  <script src="{{ url_for('static', filename='stats.js') }}"></script>
{% endblock %}
